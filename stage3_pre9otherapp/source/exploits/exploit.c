#include <string.h>
#include "../libctru/result.h"
#include "../libctru/srvpm.h"
#include "../libctru/svc.h"
#include "../libctru/os.h"
#include "../libctru/srv.h"


Result escalateServicePrivileges(Handle *wantedServiceHandle, const char *wantedServiceName)
{
        char accessList[][8] = {
            "01234567",
            "APT:U",
        };

        strncpy(accessList[0], wantedServiceName, 8);
        u32 pid;
        Handle srvPmHandle, srvHandle;
		Result ret = 0;
		
        if(R_FAILED(ret = srvPmInit(&srvPmHandle, &srvHandle))) return ret;
        if(R_FAILED(ret = svcGetProcessId(&pid, CUR_PROCESS_HANDLE))) return ret;
        if(R_FAILED(ret = SRVPM_UnregisterProcess(&srvPmHandle, pid))) return ret;
        if(R_FAILED(ret = SRVPM_RegisterProcess(&srvPmHandle, pid, sizeof(accessList)/8, accessList))) return ret;

        if(R_FAILED(ret = srvGetServiceHandle(wantedServiceHandle, wantedServiceName))) return ret;
   
        return ret;
}